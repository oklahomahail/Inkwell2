name: Repo audit

on:
  pull_request:
  workflow_dispatch:
  schedule:
    # 13:00 UTC = 8:00 AM during CDT, 7:00 AM during CST
    - cron: "0 13 * * 1"

permissions:
  contents: read

concurrency:
  group: repo-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'pnpm'   # <- optional; safe to omit when using pnpm/action-setup

      - name: Setup pnpm 9.12.0
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
          run_install: false

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run audits (via package scripts)
        run: pnpm -s ci:audit

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: repo-audit-reports
          path: reports/

      - name: Fail on audit issues
        run: |
          set -e
          echo "=== Check knip for dependency issues ==="
          if grep -Eqi "Unused dependencies|Unlisted dependencies|Unresolved" reports/knip.txt; then
            echo "::error::Knip found dependency issues"
            sed -n '1,200p' reports/knip.txt
            exit 1
          fi

          echo "=== Check madge for orphans (already filtered in script) ==="
          if [ -s reports/madge-orphans.txt ]; then
            echo "::error::Orphaned files detected"
            sed -n '1,200p' reports/madge-orphans.txt
            exit 1
          fi

          echo "=== Check madge for cycles ==="
          if ! grep -q "No circular dependency found" reports/madge-cycles.txt; then
            echo "::error::Circular dependencies detected"
            sed -n '1,200p' reports/madge-cycles.txt
            exit 1
          fi

          echo "All audit checks passed âœ…"
