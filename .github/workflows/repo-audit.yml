name: Repo audit

on:
  pull_request:
  workflow_dispatch:
  schedule:
    # 13:00 UTC = 8:00 AM CDT, 7:00 AM CST
    - cron: "0 13 * * 1"

permissions:
  contents: read

concurrency:
  group: repo-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm 9.12.0
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
          run_install: false

      - name: Run audits (via pnpm dlx – no install)
        run: |
          set -e
          mkdir -p reports
          echo "node: $(node -v)  pnpm: $(pnpm -v)"

          # knip
          pnpm dlx knip@5.63.0 \
            --dependencies --files --reporter symbols --no-exit-code --tsConfig tsconfig.json \
            | tee reports/knip.txt || true

          # depcheck (informational only)
          pnpm dlx depcheck@1.4.7 --skip-missing=true \
            | tee reports/depcheck.txt || true

          # madge from app entry (so only truly unreachable files are flagged)
          pnpm dlx madge@8.0.0 --extensions ts,tsx --ts-config tsconfig.json --orphans   src/main.tsx \
            | tee reports/madge-orphans.txt || true
          pnpm dlx madge@8.0.0 --extensions ts,tsx --ts-config tsconfig.json --circular  src/main.tsx \
            | tee reports/madge-cycles.txt  || true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: repo-audit-reports
          path: reports/

      - name: Fail on audit issues
        run: |
          set -e

          echo "=== Check knip for dependency issues ==="
          if grep -Eqi "Unused dependencies|Unlisted dependencies|Unresolved" reports/knip.txt; then
            echo "::error::Knip found dependency issues"
            sed -n '1,200p' reports/knip.txt
            exit 1
          fi

          echo "=== Check madge for orphans (excluding known roots) ==="
          # Skip header lines, normalize, keep only ts/tsx, then drop entry/ambient files.
          ORPHANS=$(
            tail -n +3 reports/madge-orphans.txt \
            | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//' \
            | grep -E '\.(ts|tsx)$' \
            | grep -Ev '(^|/)main\.tsx$|(^|/)vite-env\.d\.ts$' \
            || true
          )
          if [ -n "$ORPHANS" ]; then
            echo "::error::Orphaned files detected"
            echo "$ORPHANS"
            exit 1
          fi

          echo "=== Check madge for cycles ==="
          if ! grep -q "No circular dependency found" reports/madge-cycles.txt; then
            echo "::error::Circular dependencies detected"
            sed -n '1,200p' reports/madge-cycles.txt
            exit 1
          fi

          echo "All audit checks passed ✅"
