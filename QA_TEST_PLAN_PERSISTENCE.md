# QA Test Plan: Data Persistence Layer

## Overview

Comprehensive test plan for validating the data persistence layer implementation in PR #24.

**Target Branch:** `feat/v0.6.0-consolidation-foundation`
**Preview URL:** TBD (will be auto-generated by Vercel)
**Test Duration:** 2-3 hours
**Tester Requirements:** Chrome 90+, Firefox 88+, Safari 14+

---

## Pre-Test Setup

### Environment Configuration

1. **Feature Flags** (in Vercel environment variables):

   ```
   VITE_ENABLE_CHAPTER_MODEL=false  (remains off for this test)
   VITE_DEBUG_STORAGE=true          (enable for QA)
   ```

2. **Supabase Configuration** (required for cloud sync tests):

   ```
   VITE_SUPABASE_URL=<your-supabase-url>
   VITE_SUPABASE_ANON_KEY=<your-anon-key>
   ```

3. **Browser DevTools Setup**:
   - Open Chrome DevTools > Application tab
   - Monitor IndexedDB, LocalStorage, and Cache Storage
   - Keep Console open for debug logs

---

## Test Suite 1: Storage Health Monitoring

### Test 1.1: Initial Health Status

**Objective:** Verify health indicator displays correctly on app load

**Steps:**

1. Clear browser storage completely
2. Load the application
3. Check footer for storage status indicator

**Expected Results:**

- ✅ Storage status badge visible in footer
- ✅ Badge shows "Persisted ✓" with green color
- ✅ Health score should be 100 (or 80-100 range)
- ✅ No warnings or errors in console
- ✅ No toast notifications on load

**Pass Criteria:**

- All expected results met
- Badge updates within 5 seconds of load

---

### Test 1.2: Storage Persistence API

**Objective:** Verify persistent storage is requested and granted

**Steps:**

1. Open DevTools Console
2. Run: `navigator.storage.persisted()`
3. Observe storage manager initialization logs

**Expected Results:**

- ✅ Returns `true` (storage is persisted)
- ✅ Console shows: `[StorageManager] Storage persistence granted`
- ✅ No persistence warnings in UI

**Pass Criteria:**

- Storage persistence successfully requested
- No browser permission prompts (granted automatically)

---

### Test 1.3: Quota Monitoring

**Objective:** Verify quota information is accurate

**Steps:**

1. Click storage status indicator badge
2. Observe expanded view with quota information
3. Check DevTools Application > Storage

**Expected Results:**

- ✅ Quota bar shows current usage percentage
- ✅ Usage and available space displayed in human-readable format (MB/GB)
- ✅ Matches DevTools storage information (±5% tolerance)
- ✅ "isNearLimit" is false (usage < 80%)
- ✅ "isCritical" is false (usage < 95%)

**Pass Criteria:**

- All quota metrics display correctly
- No calculation errors in percentages

---

## Test Suite 2: Storage Quota Stress Tests

### Test 2.1: Warning Threshold (80% Usage)

**Objective:** Verify warning appears when storage reaches 80% capacity

**Setup:**

```javascript
// Run in DevTools Console to simulate 80% usage
async function fillStorageTo80Percent() {
  const estimate = await navigator.storage.estimate();
  const target = estimate.quota * 0.8;
  const chunk = new Array(1024 * 1024).join('x'); // 1MB chunk
  let filled = estimate.usage || 0;

  while (filled < target) {
    try {
      localStorage.setItem(`test_${Date.now()}`, chunk);
      filled += chunk.length * 2; // UTF-16 encoding
    } catch (e) {
      break;
    }
  }
  console.log('Filled to:', ((filled / estimate.quota) * 100).toFixed(1) + '%');
}

fillStorageTo80Percent();
```

**Expected Results:**

- ✅ Storage badge turns yellow
- ✅ Warning toast appears: "Storage usage high: XX% used"
- ✅ Health score drops to 70-85 range
- ✅ `quota.isNearLimit` returns `true`
- ✅ Console shows quota warning message

**Pass Criteria:**

- Warning appears within 5 minutes of crossing 80% threshold
- Toast can be dismissed
- Health indicator updates correctly

---

### Test 2.2: Critical Threshold (95% Usage)

**Objective:** Verify error state when storage reaches 95% capacity

**Setup:**

```javascript
// Continue from Test 2.1 or run similar script for 95%
async function fillStorageTo95Percent() {
  const estimate = await navigator.storage.estimate();
  const target = estimate.quota * 0.95;
  // ... similar to above
}

fillStorageTo95Percent();
```

**Expected Results:**

- ✅ Storage badge turns red
- ✅ Error toast appears: "Storage critically low: XX% used"
- ✅ Health score drops to 40-55 range
- ✅ `quota.isCritical` returns `true`
- ✅ Error logged to StorageErrorLogger with severity='critical'
- ✅ Suggested actions displayed in toast

**Pass Criteria:**

- Critical error appears within 5 minutes of crossing 95%
- Error persists until resolved
- Recovery suggestions are actionable

---

### Test 2.3: Storage Full (100% Usage)

**Objective:** Verify graceful degradation when storage is completely full

**Steps:**

1. Fill storage to 100% using similar script
2. Attempt to save a new project
3. Attempt to edit existing content
4. Check error handling

**Expected Results:**

- ✅ Save operations fail gracefully (no crashes)
- ✅ Error toast: "Unable to save - storage full"
- ✅ Suggested actions: "Free up space" with link to management UI
- ✅ Read operations still work
- ✅ Application remains responsive
- ✅ No data corruption

**Pass Criteria:**

- No JavaScript errors in console
- User can still navigate and read data
- Clear path to recovery presented

---

### Test 2.4: Recovery from Full Storage

**Objective:** Verify system recovers after freeing space

**Steps:**

1. From Test 2.3 state (100% full)
2. Delete old projects or test data
3. Wait for health check cycle (5 minutes) or trigger manually
4. Attempt save operation again

**Expected Results:**

- ✅ Health indicator updates to reflect freed space
- ✅ Badge color changes back to green/yellow based on new usage
- ✅ Save operations succeed
- ✅ Success toast: "Storage recovered"
- ✅ Health score increases

**Pass Criteria:**

- Recovery detected within 5 minutes
- All operations resume normally

---

## Test Suite 3: Error Handling & Logging

### Test 3.1: Network Failure During Sync

**Objective:** Verify sync fails gracefully with network issues

**Steps:**

1. Open DevTools Network tab
2. Set throttling to "Offline"
3. Attempt manual cloud sync (if implemented)
4. Check error logging

**Expected Results:**

- ✅ Error toast: "No internet connection"
- ✅ Sync icon shows failure state
- ✅ Error logged with type='sync', severity='error'
- ✅ Suggested action: "Check connection and retry"
- ✅ Local data remains intact

**Pass Criteria:**

- No crashes or unhandled promise rejections
- Error is user-friendly
- Retry mechanism available

---

### Test 3.2: IndexedDB Unavailable

**Objective:** Verify fallback when IndexedDB is disabled

**Steps:**

1. Open Chrome Settings
2. Disable cookies/site data (blocks IndexedDB)
3. Reload application
4. Check storage health

**Expected Results:**

- ✅ Health score reflects missing IndexedDB (-30 points)
- ✅ Warning: "IndexedDB unavailable - some features limited"
- ✅ Application still loads
- ✅ Falls back to LocalStorage
- ✅ `hasIndexedDB` flag is `false`

**Pass Criteria:**

- Graceful degradation to LocalStorage
- No critical failures

---

### Test 3.3: LocalStorage Quota Exceeded

**Objective:** Verify handling of LocalStorage quota errors

**Steps:**

1. Fill LocalStorage to capacity (usually 5-10MB)
2. Attempt to save additional data
3. Check error handling

**Expected Results:**

- ✅ QuotaExceededError caught
- ✅ Error logged with recovery suggestions
- ✅ Toast: "Storage limit reached"
- ✅ Suggested actions provided
- ✅ No data loss for existing items

**Pass Criteria:**

- Error caught and handled
- User notified with actionable steps

---

### Test 3.4: Storage Error Log Persistence

**Objective:** Verify errors are logged and retrievable

**Steps:**

1. Trigger various errors (quota, network, etc.)
2. Close and reopen application
3. Check if error log persists
4. Verify log rotation (max entries)

**Expected Results:**

- ✅ Error log persists across sessions
- ✅ Errors displayed in chronological order
- ✅ Each error has: timestamp, type, severity, message
- ✅ Log auto-rotates when > 100 entries
- ✅ Can be exported/cleared by user

**Pass Criteria:**

- All errors logged correctly
- Log doesn't grow unbounded

---

## Test Suite 4: UI Component Tests

### Test 4.1: StorageStatusIndicator - Compact Mode

**Objective:** Verify compact badge displays correctly

**Steps:**

1. Check footer storage indicator
2. Hover over badge
3. Click badge

**Expected Results:**

- ✅ Badge shows: "Persisted ✓ XX%"
- ✅ Color reflects health: green (80+), yellow (50-79), red (<50)
- ✅ Hover shows tooltip with details
- ✅ Click toggles expanded view

**Pass Criteria:**

- Badge always visible
- Interactive and responsive

---

### Test 4.2: StorageStatusIndicator - Expanded Mode

**Objective:** Verify expanded dashboard shows full details

**Steps:**

1. Click storage badge to expand
2. Review all displayed information
3. Test action buttons

**Expected Results:**

- ✅ Shows full health status dashboard
- ✅ Quota usage bar with percentage
- ✅ Capability checks (Persistent, IndexedDB, LocalStorage)
- ✅ Recent errors/warnings list
- ✅ Action buttons: "Request Persistence", "Clear Cache", "View Logs"
- ✅ Can collapse back to compact mode

**Pass Criteria:**

- All information accurate
- Action buttons functional

---

### Test 4.3: StorageErrorToast - Display & Dismissal

**Objective:** Verify toast notifications work correctly

**Steps:**

1. Trigger a recoverable error (e.g., network timeout)
2. Observe toast appearance
3. Wait or manually dismiss

**Expected Results:**

- ✅ Toast appears in bottom-right corner
- ✅ Shows error icon, message, and severity badge
- ✅ Auto-dismisses after 10 seconds (for recoverable errors)
- ✅ Manual dismiss button works
- ✅ Multiple toasts stack vertically
- ✅ Critical errors don't auto-dismiss

**Pass Criteria:**

- Non-intrusive placement
- Clear messaging
- Easy to dismiss

---

### Test 4.4: StorageErrorToast - Critical Errors

**Objective:** Verify critical errors display persistently

**Steps:**

1. Trigger critical error (e.g., storage 100% full)
2. Observe toast behavior
3. Attempt to dismiss

**Expected Results:**

- ✅ Toast has red background and critical icon
- ✅ Does NOT auto-dismiss
- ✅ Shows recovery actions prominently
- ✅ Can be dismissed only after acknowledging
- ✅ Reappears on page reload if not resolved

**Pass Criteria:**

- Forces user attention
- Provides clear recovery path

---

## Test Suite 5: Cloud Sync (Manual)

### Test 5.1: Supabase Connection Validation

**Objective:** Verify Supabase authentication works

**Prerequisites:**

- Valid Supabase URL and anon key configured
- User authenticated (if required)

**Steps:**

1. Check app initialization logs
2. Verify Supabase client initialization
3. Test connection with ping/health check

**Expected Results:**

- ✅ Supabase client initializes successfully
- ✅ No authentication errors in console
- ✅ Connection confirmed with API call
- ✅ User session validated (if authenticated)

**Pass Criteria:**

- Clean initialization
- No 401/403 errors

---

### Test 5.2: Manual Push to Cloud

**Objective:** Verify data can be pushed to Supabase

**Steps:**

1. Create test project with sample data
2. Trigger manual sync/push
3. Check Supabase dashboard for data
4. Verify data integrity

**Expected Results:**

- ✅ Push operation completes without errors
- ✅ Success toast: "Synced to cloud"
- ✅ Data appears in Supabase tables
- ✅ Timestamp updated correctly
- ✅ All fields populated (projects, chapters, characters)

**Pass Criteria:**

- Data matches local exactly
- No corruption or data loss

---

### Test 5.3: Manual Pull from Cloud

**Objective:** Verify data can be pulled from Supabase

**Steps:**

1. Clear local storage
2. Trigger manual sync/pull
3. Verify local data restored
4. Compare with cloud data

**Expected Results:**

- ✅ Pull operation completes successfully
- ✅ All projects restored locally
- ✅ Chapters and characters loaded
- ✅ Timestamps preserved
- ✅ No data corruption

**Pass Criteria:**

- Local data matches cloud
- Full restoration successful

---

### Test 5.4: Sync Error Handling

**Objective:** Verify sync errors are handled gracefully

**Steps:**

1. Provide invalid Supabase credentials
2. Attempt sync operation
3. Check error handling
4. Restore valid credentials and retry

**Expected Results:**

- ✅ Auth error caught and logged
- ✅ Error toast: "Authentication failed"
- ✅ Local data unchanged
- ✅ Retry option available
- ✅ Success after credentials fixed

**Pass Criteria:**

- No crashes on auth failure
- Clear error messages

---

## Test Suite 6: Browser Compatibility

### Test 6.1: Chrome

**Objective:** Verify all features work in Chrome 90+

**Steps:**

1. Run full test suite in Chrome
2. Check DevTools for errors
3. Verify all features functional

**Expected Results:**

- ✅ All tests pass
- ✅ No console errors
- ✅ Storage API fully supported
- ✅ IndexedDB working

**Pass Criteria:**

- 100% feature parity

---

### Test 6.2: Firefox

**Objective:** Verify features work in Firefox 88+

**Steps:**

1. Run core tests in Firefox
2. Check for browser-specific issues
3. Verify IndexedDB implementation

**Expected Results:**

- ✅ Storage persistence API works
- ✅ IndexedDB functional
- ✅ Quota API supported
- ✅ No Firefox-specific errors

**Pass Criteria:**

- Core features work
- Minor UI differences acceptable

---

### Test 6.3: Safari

**Objective:** Verify features work in Safari 14+

**Steps:**

1. Run core tests in Safari
2. Check for WebKit quirks
3. Verify persistence API

**Expected Results:**

- ✅ IndexedDB works
- ⚠️ Storage persistence API may be limited
- ✅ Graceful fallback if persistence not supported
- ✅ LocalStorage works

**Pass Criteria:**

- Core features functional
- Graceful degradation for unsupported APIs

---

## Test Suite 7: Performance & Monitoring

### Test 7.1: Health Check Interval

**Objective:** Verify health checks run every 5 minutes

**Steps:**

1. Note initial health check timestamp
2. Wait 5 minutes
3. Check for health update
4. Verify interval consistency

**Expected Results:**

- ✅ Health check runs exactly every 5 minutes (±10s)
- ✅ Console logs show check execution
- ✅ UI updates with new health data
- ✅ No performance impact

**Pass Criteria:**

- Consistent interval
- Minimal CPU usage

---

### Test 7.2: Storage Operations Performance

**Objective:** Verify storage operations are fast

**Steps:**

1. Measure time for save operation
2. Measure time for load operation
3. Measure health check duration
4. Check for blocking operations

**Expected Results:**

- ✅ Save: < 100ms for typical project
- ✅ Load: < 200ms for typical project
- ✅ Health check: < 50ms
- ✅ No UI freezing during operations

**Pass Criteria:**

- All operations under threshold
- UI remains responsive

---

### Test 7.3: Memory Usage

**Objective:** Verify no memory leaks

**Steps:**

1. Open Chrome DevTools > Memory
2. Take heap snapshot
3. Perform multiple save/load cycles
4. Take another snapshot
5. Compare memory usage

**Expected Results:**

- ✅ Memory usage stable over time
- ✅ No retained detached DOM nodes
- ✅ Event listeners cleaned up properly
- ✅ No growing arrays/objects

**Pass Criteria:**

- Memory delta < 10MB after 100 operations

---

## Test Suite 8: Feature Flag Validation

### Test 8.1: Chapter Model Flag OFF (Default)

**Objective:** Verify legacy scene-based model still works

**Configuration:**

```
VITE_ENABLE_CHAPTER_MODEL=false
```

**Steps:**

1. Create new project
2. Add scenes (legacy flow)
3. Verify persistence layer handles legacy data
4. Check for adapter usage

**Expected Results:**

- ✅ Scene-based UI displays
- ✅ Adapters convert scenes to chapters transparently
- ✅ Storage saves in compatible format
- ✅ No errors or warnings

**Pass Criteria:**

- Legacy flow fully functional
- Persistence layer compatible

---

### Test 8.2: Chapter Model Flag ON (Preview)

**Objective:** Verify new chapter-only model works

**Configuration:**

```
VITE_ENABLE_CHAPTER_MODEL=true
```

**Steps:**

1. Create new project
2. Add chapters directly (no scenes)
3. Verify persistence layer handles new format
4. Check for direct chapter access

**Expected Results:**

- ✅ Chapter-based UI displays
- ✅ No scene references visible
- ✅ Storage uses new chapter format
- ✅ All features work with chapters

**Pass Criteria:**

- New model fully functional
- No legacy code paths executed

---

## Test Suite 9: Regression Testing

### Test 9.1: Existing Projects Load Correctly

**Objective:** Verify no data loss for existing users

**Steps:**

1. Use backup of production database (anonymized)
2. Load into test environment
3. Verify all projects accessible
4. Check data integrity

**Expected Results:**

- ✅ All existing projects load
- ✅ No data corruption
- ✅ Timestamps preserved
- ✅ Relationships intact (chapters, characters)

**Pass Criteria:**

- 100% success rate
- No data migrations required

---

### Test 9.2: Core Features Still Work

**Objective:** Verify persistence layer doesn't break existing features

**Steps:**

1. Create new project
2. Add chapters/scenes
3. Add characters
4. Use timeline feature
5. Export project
6. Use AI features

**Expected Results:**

- ✅ All features functional
- ✅ No new errors introduced
- ✅ Performance unchanged
- ✅ UI/UX consistent

**Pass Criteria:**

- No regressions detected
- Feature parity maintained

---

## Test Execution Checklist

### Pre-Test

- [ ] Preview environment deployed
- [ ] Environment variables configured
- [ ] Supabase keys validated
- [ ] Test data prepared
- [ ] Browser DevTools ready

### During Testing

- [ ] Record all issues found
- [ ] Screenshot errors
- [ ] Copy console logs
- [ ] Note browser/OS info
- [ ] Time stamp each test

### Post-Test

- [ ] Compile test results
- [ ] Create bug tickets for failures
- [ ] Update PR with QA results
- [ ] Get sign-off from team
- [ ] Clear test data

---

## Success Criteria

### Must Pass (Blocking)

- ✅ No critical errors or crashes
- ✅ Storage persistence API works
- ✅ Quota monitoring accurate
- ✅ All thresholds trigger correctly (80%, 95%, 100%)
- ✅ Error handling graceful
- ✅ No data loss or corruption
- ✅ Core features still work
- ✅ Chrome support complete

### Should Pass (High Priority)

- ✅ Firefox support complete
- ✅ Safari support with graceful degradation
- ✅ Cloud sync works (with valid credentials)
- ✅ Performance metrics met
- ✅ No memory leaks
- ✅ UI components responsive

### Nice to Have (Medium Priority)

- ⚠️ Expanded health dashboard
- ⚠️ Error log export feature
- ⚠️ Advanced quota management UI

---

## Test Report Template

```markdown
# QA Test Report: Data Persistence Layer

**Date:** YYYY-MM-DD
**Tester:** [Name]
**Environment:** [Preview URL]
**Browser:** [Chrome XX, Firefox XX, Safari XX]

## Summary

- Total Tests: X
- Passed: X
- Failed: X
- Blocked: X
- Pass Rate: XX%

## Critical Issues

1. [Issue description]
   - Severity: Critical/High/Medium/Low
   - Steps to reproduce
   - Expected vs Actual
   - Screenshots/logs

## Test Results by Suite

- Suite 1: Storage Health Monitoring - ✅ Pass / ❌ Fail
- Suite 2: Quota Stress Tests - ✅ Pass / ❌ Fail
- ...

## Recommendations

- [ ] Ready to merge
- [ ] Needs fixes (list blockers)
- [ ] Needs additional testing

## Sign-off

Approved by: [Name]
Date: YYYY-MM-DD
```

---

## Appendix: Test Scripts

### Storage Fill Script

```javascript
// Fill storage to specific percentage
async function fillStorageToPercent(targetPercent) {
  const estimate = await navigator.storage.estimate();
  const target = estimate.quota * (targetPercent / 100);
  const chunk = new Array(1024 * 1024).join('x');
  let filled = estimate.usage || 0;

  console.log(`Target: ${targetPercent}% = ${(target / 1024 / 1024).toFixed(2)} MB`);

  while (filled < target) {
    try {
      const key = `test_${Date.now()}_${Math.random()}`;
      localStorage.setItem(key, chunk);
      filled += chunk.length * 2;

      if (filled % (10 * 1024 * 1024) < chunk.length * 2) {
        console.log(`Filled: ${((filled / estimate.quota) * 100).toFixed(1)}%`);
      }
    } catch (e) {
      console.error('Storage full at:', ((filled / estimate.quota) * 100).toFixed(1) + '%');
      break;
    }
  }

  const final = await navigator.storage.estimate();
  console.log('Final usage:', ((final.usage / final.quota) * 100).toFixed(1) + '%');
}

// Usage:
// fillStorageToPercent(80); // Fill to 80%
// fillStorageToPercent(95); // Fill to 95%
```

### Storage Clear Script

```javascript
// Clear all test data
function clearTestStorage() {
  const keys = Object.keys(localStorage);
  let cleared = 0;

  keys.forEach((key) => {
    if (key.startsWith('test_')) {
      localStorage.removeItem(key);
      cleared++;
    }
  });

  console.log(`Cleared ${cleared} test items`);
}

// Usage:
// clearTestStorage();
```

### Health Status Inspector

```javascript
// Get current health status
async function inspectHealthStatus() {
  // Assuming storageManager is globally accessible or via window
  const status = await window.storageManager?.getHealthStatus();
  console.table({
    'Is Persistent': status.isPersistent,
    'Has IndexedDB': status.hasIndexedDB,
    'Has LocalStorage': status.hasLocalStorage,
    'Health Score': status.healthScore,
    'Quota Used': `${(status.quota.percentUsed * 100).toFixed(1)}%`,
    'Is Near Limit': status.quota.isNearLimit,
    'Is Critical': status.quota.isCritical,
    Errors: status.errors.length,
    Warnings: status.warnings.length,
  });
  return status;
}

// Usage:
// await inspectHealthStatus();
```

---

**Document Version:** 1.0
**Last Updated:** 2025-10-30
**Author:** QA Team / Claude Code
